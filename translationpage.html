<!DOCTYPE html>
<!-- WHOEVER COMES HERE BE AWARE THAT THIS PIECE OF CODE IS UNMAINTAINABLE DO NOT ATTEMPT TO SPEND TOO MUCH TIME HERE -->
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TF2TP Translation tool</title>
    <style>
      :root {
        --bg: #0e1020;
        --panel: #151726;
        --muted: #2b2f3f;
        --text: #e7eef8;
        --sub: #9fb0c6;
        --accent: #7cc7ff;
        --warn: #ffb454;
        --good: #42d392;
        --card: #0f1220;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;
        background: radial-gradient(
            800px 400px at 10% -10%,
            #171827 0,
            transparent 40%
          ),
          var(--bg);
        color: var(--text);
      }
      .container {
        max-width: 90%;
        margin: 24px auto;
        padding: 18px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 20px;
      }
      .subtitle {
        color: var(--sub);
        margin-bottom: 14px;
      }

      .layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
      }
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid var(--muted);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }
      .card .body {
        padding: 14px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .input,
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--muted);
        background: #0d111a;
        color: var(--text);
        box-sizing: border-box;
        font-size: 14px;
      }
      textarea {
        min-height: 90px;
        resize: vertical;
      }
      .btn {
        appearance: none;
        border: none;
        padding: 10px 12px;
        border-radius: 12px;
        background: #17243b;
        color: var(--text);
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        background: linear-gradient(180deg, #2a6fb4, #1f4b85);
      }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--muted);
        color: var(--sub);
        background: #0e1220;
      }

      /* Editor grid */
      .editor-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      @media (min-width: 980px) {
        .editor-grid {
          grid-template-columns: 1fr;
        }
      }

      .kv-row {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 10px;
        align-items: start;
      }
      @media (max-width: 760px) {
        .kv-row {
          grid-template-columns: 1fr;
        }
      }
      .kv-row label {
        color: var(--sub);
        padding-top: 6px;
      }

      /* Two-column bilingual */
      .bilingual {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .col {
        display: flex;
        flex-direction: column;
        gap: 6px;
        background: #0a0d16;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: var(--text);
        padding: 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",
          monospace;
        font-size: 13px;
        box-sizing: border-box;
      }

      textarea.common,
      input.common {
        background: #0a0d16;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: var(--text);
        padding: 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",
          monospace;
        font-size: 13px;
        box-sizing: border-box;
      }
      textarea.common[readonly] {
        opacity: 0.9;
      }
      .missing {
        box-shadow: inset 0 0 0 2px var(--warn) !important;
        border-color: var(--warn) !important;
        background: #0a0d16;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: var(--text);
        padding: 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",
          monospace;
        font-size: 13px;
        box-sizing: border-box;
        height: 100%;
        width: 100%;
      }
      .key-label {
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 6px;
      }
      .small-note {
        font-size: 12px;
        color: var(--sub);
      }

      .footer {
        color: var(--sub);
        font-size: 13px;
        margin-top: 10px;
      }

      /* Diff viewer */
      .diffBox {
        white-space: pre-wrap;
        background: #071018;
        border: 1px solid #234;
        padding: 12px;
        border-radius: 10px;
        margin-top: 12px;
        color: var(--text);
        overflow: auto;
        max-height: 360px;
      }
      .diffBox ins {
        background: #063b1a;
        color: #bff7c9;
        text-decoration: none;
      }
      .diffBox del {
        background: #3e0b0b;
        color: #ffbdbd;
        text-decoration: none;
      }

      /* key tags */
      .keysbar {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .tag {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--muted);
        color: var(--sub);
        font-size: 13px;
      }

      #emptyBox {
        position: fixed; /* reste fix√© dans la fen√™tre */
        top: 20px; /* distance du haut */
        right: 20px; /* distance du bord droit */
        width: 200px; /* largeur fixe (ajuste si tu veux) */
        padding: 10px;
        background: #2b2b2b; /* adapt√© √† ton th√®me sombre */
        color: #ddd;
        border: 1px solid #555;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 999; /* passe devant tout */
      }

      .rich-editor {
        border: 1px solid var(--muted);
        padding: 8px;
        border-radius: 10px;
        min-height: 80px;
        font-family: ui-monospace;
        white-space: pre-wrap;
      }

      .rich-editor .non-editable {
        color: #888;
        user-select: none;
      }

      .rich-editor .editable {
        color: var(--text);
      }

      /* Affichage des balises HTML dans les textes */
      .html-tag {
        font-family: monospace;
        border-radius: 3px;
        padding: 0 2px;
        background: rgba(255, 165, 0, 0.1);
      }

      /* Mod√®le anglais (gauche) */
      .en .html-tag {
        color: #f97316; /* orange */
      }

      /* Zone d'√©dition fran√ßaise (droite) */
      .editable .html-tag {
        color: gray;
        background: rgba(128, 128, 128, 0.15);
        cursor: not-allowed;
      }

      .warning {
        position: relative;
        width: 100%;
        text-align: center;
        font-size: 14pt;
        font-family: BigNoodleTitling;
        background-color: hsl(51, 78%, 42%);
        color: rgb(33, 34, 27);
        padding: 5px;
        margin: 0px !important;
      }
    </style>
  </head>
  <body>
    <p class="warning" id="WIPText">
      ‚ö†Ô∏è DO NOT CLOSE THIS TAB UNTIL YOU ARE SURE YOU'VE SAVED YOUR CHANGES ‚ö†Ô∏è FOLLOW THE STEPS AND EVERYTING WILL BE FINE !
    </p>
    <div class="container">
      <h1>
        Edit translations.js easily <br />
      </h1>
      <div class="subtitle">
        Prerequisites : <br>
        You have a GitHub account (You save me some time)<br>
        AND / OR<br>
        You have a discord account and you're on the TF2TP's server (You shouldn't feel guitly making me lose some time, I'm the one at fault here for not doing a better system)<br><br>

        1) Load up a file (preferably from github),<br> 2) edit it,<br> 3) then you can
        either export to github (here this basically means copying the file) and do a pull request, or paste it into the
        discord's translation ressources. <br><br>Export in github : Send to github then
        hit ctrl+A then ctrl+V and click commit then click pull request. The
        commit description will be "[Your language tag] update"<br><br>Sending it to discord : Click "copy translation.js" 
      </div>

      <div class="layout">
        <!-- left panel -->
        <section class="card">
          <div class="body">
            <h3>1) Loadin' n' parsin'</h3>
            <div class="row" style="margin-bottom: 8px">
              <input
                id="fileInput"
                class="input"
                type="file"
                accept=".js,.json"
              />
              <button id="btnLoadSample" class="btn">Load from GitHub</button>
            </div>
            <textarea
              id="rawArea"
              placeholder="Or paste your content here (const translations = {...};)"
            ></textarea>
            <div class="row" style="margin-top: 8px">
              <button id="btnParse" class="btn primary">Analyse</button>
              <span id="statusParsed" class="pill">Not analysed</span>
            </div>

            <hr
              style="
                border: none;
                border-top: 1px solid var(--muted);
                margin: 12px 0;
              "
            />
            <h3>2) Editing options</h3>
            <div style="margin-bottom: 8px">
              <label for="langSelect" class="small-note"
                >Language to edit</label
              >
              <select id="langSelect" class="input"></select>
            </div>
            <div style="margin-bottom: 8px" class="row">
              <input
                id="filterInput"
                class="input"
                placeholder="Filter by key (ex: tf01Title)"
              />
              <label style="display: flex; align-items: center; gap: 8px"
                ><input id="toggleShowEN" type="checkbox" checked />Show
                original</label
              >
            </div>
            <!-- Filtre "vides" -->
            <div class="row" style="margin-bottom: 8px; flex-wrap: wrap">
              <label style="display: flex; align-items: center; gap: 8px">
                <input id="toggleOnlyEmpty" type="checkbox" /> Only show empty
              </label>
            </div>
            <div class="keysbar" id="keysBar"></div>

            <div style="margin-top: 10px" class="row">
              <button id="btnSaveMem" class="btn">Save (local)</button>
              <button id="btnLoadMem" class="btn">Load local</button>
            </div>

            <div class="footer">
              Everything works on clientside. On export, your work is copied to
              your clipboard and the github editor opens up and you can replace
              everything here (ctrl+a and ctrl+v). Then click the pull request
              button (the green one)
            </div>
          </div>
        </section>

        <!-- right panel -->
        <section class="card">
          <div class="body">
            <h3>3) Editing (Original on the left, your translation)</h3>

            <div id="editor" class="editor-grid"></div>

            <div style="margin-top: 10px" class="row">
              <button id="btnSave" class="btn">Update the model</button>
              <button id="btnCopy" class="btn">Copy translations.js</button>
              <button id="btnDownload" class="btn">
                Download translations.js
              </button>
              <button id="btnDownloadJSON" class="btn">Export as JSON</button>
              <button id="btnShowDiffFile" class="btn">See diff</button>
            </div>

            <hr
              style="
                border: none;
                border-top: 1px solid var(--muted);
                margin: 12px 0;
              "
            />
            <h3>4) Send to GitHub</h3>

            <!-- Section par d√©faut -->
            <div class="row" id="defaultGhSection">
              <button id="btnOpenPRDefault" class="btn primary">
                üì§ Send to DRUN-s/translations.js
              </button>
              <span class="pill">Copy + directly opens GitHub editor</span>
            </div>

            <!-- Section avanc√©e (masqu√©e au d√©part) -->
            <div id="advancedGhSection" style="display: none; margin-top: 12px">
              <h4>Send somewhere else</h4>
              <div class="row">
                <input
                  id="ghOwner"
                  class="input"
                  placeholder="Owner (ex: druns)"
                />
                <input
                  id="ghRepo"
                  class="input"
                  placeholder="Repo (ex: tf2-comics-site)"
                />
              </div>
              <div class="row" style="margin-top: 8px">
                <input
                  id="ghBranch"
                  class="input"
                  placeholder="Branch (ex: main)"
                />
                <input
                  id="ghPath"
                  class="input"
                  placeholder="Path (ex: src/data/translations.js)"
                />
              </div>
              <div style="margin-top: 8px" class="row">
                <button id="btnOpenPRCustom" class="btn">
                  üì§ Open custom github editor
                </button>
              </div>
            </div>

            <!-- Bouton pour afficher l‚Äôavanc√© -->
            <div style="margin-top: 8px">
              <button id="toggleAdvanced" class="btn">
                ‚öôÔ∏è Send to another destination
              </button>
            </div>
          </div>
        </section>
      </div>

      <div style="margin-top: 12px; color: var(--sub); font-size: 13px">
        This small tool was made with love (but also a lot with chatGPT) by
        DRUNs üá´üá∑ <img src="/images/GIFs/spyKazotsky.gif" /> for the TF2 Comics
        translation project. Dear translator I wish you a good luck !
        <img src="/images/GIFs/demoDance.gif" />
      </div>
    </div>

    <div
      id="toast"
      style="
        position: fixed;
        right: 18px;
        bottom: 18px;
        background: #081220;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #234;
        color: var(--text);
        opacity: 0;
        transform: translateY(10px);
        transition: 0.25s;
      "
    ></div>

    <!-- Bo√Æte flottante sticky : compteur + navigation -->
    <div id="emptyBox">
      <span id="emptyCounter">Empty : 0 / 0 ‚Äî Progress : 0%</span>
      <div style="display: flex; gap: 6px; margin-top: 6px">
        <button id="btnPrevEmpty" class="btn" title="Pr√©c√©dent vide">‚¨ÜÔ∏è</button>
        <button id="btnNextEmpty" class="btn" title="Suivant vide">‚¨áÔ∏è</button>
      </div>
    </div>
    <script>
      // ---------- Etat ------------------------------------------------------
      const state = {
        translations: null,
        originalSnapshot: null,
        langs: [],
        keys: [],
        activeLang: null,
        baseLang: "EN",
      };

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      function toast(msg) {
        const t = $("#toast");
        t.textContent = msg;
        t.style.opacity = 1;
        t.style.transform = "translateY(0)";
        setTimeout(() => {
          t.style.opacity = 0;
          t.style.transform = "translateY(10px)";
        }, 1800);
      }

      // ---------- Parsing helpers ------------------------------------------
      function stripJsComments(src) {
        return src
          .replace(/\/\*[\s\S]*?\*\//g, "")
          .replace(/(^|[^:\\])\/\/.*$/gm, "$1");
      }

      function safeParseTranslations(src) {
        const cleaned = stripJsComments(src);
        function grabBalancedObject(str, startIndex) {
          let i = startIndex,
            depth = 0,
            inString = false,
            quote = "",
            escaped = false;
          for (; i < str.length; i++) {
            const ch = str[i];
            if (inString) {
              if (escaped) {
                escaped = false;
                continue;
              }
              if (ch === "\\") {
                escaped = true;
                continue;
              }
              if (ch === quote) {
                inString = false;
                continue;
              }
              continue;
            }
            if (ch === '"' || ch === "'" || ch === "`") {
              inString = true;
              quote = ch;
              continue;
            }
            if (ch === "{") {
              depth++;
            } else if (ch === "}") {
              depth--;
              if (depth === 0) return str.slice(startIndex, i + 1);
            }
          }
          throw new Error("Unable to find the end of the object translations.");
        }
        let body = null;
        const tIdx = cleaned.indexOf("translations");
        if (tIdx !== -1) {
          const eqIdx = cleaned.indexOf("=", tIdx);
          const braceIdx = eqIdx === -1 ? -1 : cleaned.indexOf("{", eqIdx);
          if (braceIdx !== -1) body = grabBalancedObject(cleaned, braceIdx);
        }
        if (!body) {
          const firstBrace = cleaned.indexOf("{");
          if (firstBrace !== -1) body = grabBalancedObject(cleaned, firstBrace);
        }
        if (!body)
          throw new Error(
            "No object found, check if the code contain something like `const translations = { ... }`."
          );
        const fn = new Function('"use strict"; return (' + body + ");");
        const obj = fn();
        if (!obj || typeof obj !== "object")
          throw new Error("Whatever you loaded does not countain any object.");
        return obj;
      }

      function deriveKeysAndLangs(obj) {
        const langs = Object.keys(obj || {});
        const keys = Array.from(
          new Set(langs.flatMap((l) => Object.keys(obj[l] || {})))
        ).sort();
        return { langs, keys };
      }

      // --- Focus suivi pour la navigation entre vides ---
      let lastEditorFocus = null;
      document.addEventListener("focusin", (e) => {
        if (e.target.matches("#editor .common:not([readonly])")) {
          lastEditorFocus = e.target;
        }
      });

      // ---------- HTML tags rendering helpers (for protected editing) ------
      function splitHtmlParts(text) {
        return text.split(/(<[^>]+>)/g).filter(Boolean);
      }

      function createProtectedEditable(enValue, frValue = "") {
        const container = document.createElement("div");
        container.classList.add("editable");
        container.contentEditable = "true";

        const enParts = splitHtmlParts(enValue);
        const frParts = splitHtmlParts(frValue || enValue);

        enParts.forEach((part, i) => {
          if (part.startsWith("<") && part.endsWith(">")) {
            const tag = document.createElement("span");
            tag.textContent = part;
            tag.classList.add("html-tag");
            tag.contentEditable = "false"; // üîí non modifiable
            container.appendChild(tag);
          } else {
            const span = document.createElement("span");
            span.textContent =
              frParts[i] && !frParts[i].match(/^<[^>]+>$/) ? frParts[i] : "";
            span.classList.add("translatable");
            container.appendChild(span);
          }
        });

        return container;
      }

      function highlightTags(text) {
        return text.replace(/(<[^>]+>)/g, '<span class="html-tag">$1</span>');
      }

      function getTranslatedText(editableDiv) {
        let result = "";
        editableDiv.childNodes.forEach((node) => {
          if (node.classList?.contains("html-tag")) {
            result += node.textContent;
          } else {
            result += node.textContent;
          }
        });
        return result;
      }

      // ---------- Renderers ------------------------------------------------
      function updateParsedStatus(ok) {
        const pill = $("#statusParsed");
        pill.textContent = ok ? "Analys√©" : "Non analys√©";
        pill.style.borderColor = ok ? "transparent" : "";
      }

      function renderLangs() {
        const sel = $("#langSelect");
        sel.innerHTML = state.langs
          .map((l) => `<option value="${l}">${l}</option>`)
          .join("");
        if (!state.activeLang) state.activeLang = sel.value || state.langs[0];
        sel.value = state.activeLang;
      }
      function renderKeysBar() {
        const kb = $("#keysBar");
        kb.innerHTML = state.keys
          .map((k) => `<span class="tag">${k}</span>`)
          .join("");
      }

      function renderEditor() {
        const ed = $("#editor");
        ed.innerHTML = "";
        if (!state.translations) return;
        const showEN = $("#toggleShowEN").checked;
        const L = state.activeLang || state.langs[0];
        const base = state.baseLang;
        const filter = $("#filterInput").value.trim().toLowerCase();
        const onlyEmpty = $("#toggleOnlyEmpty")
          ? $("#toggleOnlyEmpty").checked
          : false;

        state.keys.forEach((k) => {
          // filtre par cl√©
          if (filter && !k.toLowerCase().includes(filter)) return;

          // valeur courante pour la langue active (doit √™tre au d√©but de l'it√©ration)
          const currentVal =
            (state.translations[L] && state.translations[L][k]) || "";

          const isEmpty =
            currentVal === undefined ||
            currentVal === null ||
            String(currentVal).trim() === "";

          // filtre "uniquement vides"
          if (onlyEmpty && !isEmpty) return;

          const container = document.createElement("div");
          container.className = "kv-row";

          const labelWrap = document.createElement("div");
          const label = document.createElement("div");
          label.className = "key-label";
          label.textContent = k;
          labelWrap.appendChild(label);
          const inlineNote = document.createElement("div");
          inlineNote.className = "small-note";
          inlineNote.textContent = "";
          labelWrap.appendChild(inlineNote);
          container.appendChild(labelWrap);

          // bilingual or single column
          const content = document.createElement("div");

          if (showEN && L !== base) {
            content.className = "bilingual";

            // --- colonne originale (EN) ---
            const colOrig = document.createElement("div");
            colOrig.className = "col en";

            // on utilise textarea readonly pour garder le comportement ant√©rieur
            const origTA = document.createElement("textarea");
            origTA.className = "common";
            origTA.readOnly = true;
            origTA.value =
              (state.translations[base] && state.translations[base][k]) || "";
            colOrig.appendChild(origTA);

            // --- colonne traduction (FR) avec balises prot√©g√©es ---
            const colTrans = document.createElement("div");
            colTrans.className = "col";

            const editable = createProtectedEditable(
              (state.translations[base] && state.translations[base][k]) || "",
              currentVal
            );
            editable.dataset.key = k;

            // marqueur "missing" adapt√© aux contenteditable
            function setMissingForEditable(el) {
              const v = (getTranslatedText(el) ?? "").trim();
              if (v === "") el.classList.add("missing");
              else el.classList.remove("missing");
            }
            setMissingForEditable(editable);

            // mini-diff
            const diffMini = document.createElement("div");
            diffMini.className = "small-note";
            diffMini.style.marginTop = "6px";
            colTrans.appendChild(diffMini);

            let tmr = null;
            const computeMini = () => {
              try {
                const a = origTA.value || "";
                const b = getTranslatedText(editable) || "";
                const diff = Diff.diffWords(a, b);
                diffMini.innerHTML = diff
                  .map((p) =>
                    p.added
                      ? `<ins>+${escapeHtml(truncate(p.value, 40))}</ins>`
                      : p.removed
                      ? `<del>-${escapeHtml(truncate(p.value, 40))}</del>`
                      : escapeHtml(truncate(p.value, 40))
                  )
                  .join("");
              } catch (e) {
                diffMini.textContent = "";
              }
            };

            // mise √† jour du mod√®le lors de l'√©dition
            editable.addEventListener("input", () => {
              clearTimeout(tmr);
              tmr = setTimeout(computeMini, 250);

              if (!state.translations[L]) state.translations[L] = {};
              state.translations[L][k] = getTranslatedText(editable);
              setMissingForEditable(editable);
              updateCounter();
            });

            // calcul initial et ajout dans le DOM
            computeMini();
            colTrans.appendChild(editable);

            content.appendChild(colOrig);
            content.appendChild(colTrans);
          } else {
            // single column (for EN or when user hides EN)
            const col = document.createElement("div");
            col.className = "col";
            const isLong = /Text$/.test(k) || String(currentVal).length > 120;

            // Si tu veux conserver textarea/input simple pour ce cas :
            const field = document.createElement(isLong ? "textarea" : "input");
            field.className = "common";
            if (!isLong) field.type = "text";
            field.value = currentVal || "";
            field.dataset.key = k;
            setMissingClass(field);
            field.addEventListener("input", (e) => {
              if (!state.translations[L]) state.translations[L] = {};
              state.translations[L][k] = e.target.value;
              setMissingClass(e.target);
              updateCounter();
            });
            col.appendChild(field);
            content.appendChild(col);
          }

          container.appendChild(content);
          ed.appendChild(container);

          // MAJ compteur apr√®s (re)rendu
          updateCounter();
        });

        // MAJ compteur apr√®s (re)rendu
        updateCounter();
      }

      function setMissingClass(el) {
        if (!el) return;

        // Cas contenteditable
        if (el.classList.contains("editable")) {
          const v = (getTranslatedText(el) ?? "").trim();
          if (v === "") el.classList.add("missing");
          else el.classList.remove("missing");
          return;
        }

        // Cas input / textarea
        const v = (el.value ?? "").trim();
        if (v === "") el.classList.add("missing");
        else el.classList.remove("missing");
      }

      function escapeHtml(s) {
        return s.replace(
          /[&<>]/g,
          (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])
        );
      }
      function truncate(s, n) {
        return s.length > n ? s.slice(0, n - 1) + "‚Ä¶" : s;
      }

      function updateCounter() {
        const el = $("#emptyCounter");
        if (!el || !state.translations || !state.keys || !state.keys.length)
          return;

        const L = state.activeLang || state.langs[0];
        const total = state.keys.length;
        let empty = 0;
        for (const k of state.keys) {
          const v = (state.translations[L] && state.translations[L][k]) || "";
          if (String(v).trim() === "") empty++;
        }

        const filled = total - empty;
        const progress = total ? Math.round((filled / total) * 100) : 0;
        el.textContent = `Empty : ${empty} / ${total} ‚Äî Progress : ${progress}%`;
      }

      function navigateEmpty(direction) {
        // Inclure √† la fois les champs classiques et les contenteditable
        const empties = Array.from(
          document.querySelectorAll("#editor .missing:not([readonly])")
        );

        if (!empties.length) return;

        let step = 1;
        if (typeof direction === "number") {
          step = direction >= 0 ? 1 : -1;
        } else if (typeof direction === "string") {
          step = direction.toLowerCase().startsWith("n") ? 1 : -1;
        }

        let idx = -1;
        if (lastEditorFocus && empties.includes(lastEditorFocus)) {
          idx = empties.indexOf(lastEditorFocus);
        } else if (empties.includes(document.activeElement)) {
          idx = empties.indexOf(document.activeElement);
        } else {
          idx = step > 0 ? -1 : 0;
        }

        idx = (idx + step + empties.length) % empties.length;

        const target = empties[idx];
        lastEditorFocus = target;
        target.focus({ preventScroll: true });
        target.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      // ---------- Events ---------------------------------------------------

      $("#toggleOnlyEmpty")?.addEventListener("change", () => renderEditor());
      const prevBtn = $("#btnPrevEmpty");
      const nextBtn = $("#btnNextEmpty");

      if (prevBtn) {
        prevBtn.addEventListener("mousedown", (e) => {
          e.preventDefault();
          navigateEmpty(-1);
        });
        prevBtn.addEventListener("click", (e) => e.preventDefault()); // √©vite de voler le focus
      }
      if (nextBtn) {
        nextBtn.addEventListener("mousedown", (e) => {
          e.preventDefault();
          navigateEmpty(1);
        });
        nextBtn.addEventListener("click", (e) => e.preventDefault());
      }

      $("#btnParse").addEventListener("click", () => {
        try {
          const obj = safeParseTranslations($("#rawArea").value);
          state.translations = obj;
          state.originalSnapshot = JSON.parse(JSON.stringify(obj));
          const meta = deriveKeysAndLangs(obj);
          state.langs = meta.langs;
          state.keys = meta.keys;
          state.activeLang = state.langs.includes("FR") ? "FR" : state.langs[0];
          renderLangs();
          renderKeysBar();
          renderEditor();
          updateParsedStatus(true);
          toast("Fichier analys√©");
        } catch (err) {
          updateParsedStatus(false);
          alert("Erreur d'analyse : " + err.message);
          console.error(err);
        }
      });

      $("#fileInput").addEventListener("change", async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const txt = await f.text();
        $("#rawArea").value = txt;
        $("#btnParse").click();
      });
      $("#btnLoadSample").addEventListener("click", async () => {
        try {
          const url =
            "https://raw.githubusercontent.com/DRUN-s/DRUN-s.github.io/main/scripts/translations.js";
          const res = await fetch(url);
          if (!res.ok) throw new Error(res.status + " " + res.statusText);
          const txt = await res.text();
          $("#rawArea").value = txt;
          $("#btnParse").click();
          toast("File loaded from GitHub");
        } catch (err) {
          alert("Couldn't load from GitHub : " + err.message);
        }
      });
      $("#btnLoadSample").addEventListener("click", () => {
        /* fallback kept for older browsers that don't support fetch in some contexts */
      });
      $("#btnLoadSample").addEventListener("click", () => {});
      $("#btnLoadSample").addEventListener("click", () => {});

      $("#langSelect").addEventListener("change", (e) => {
        state.activeLang = e.target.value;
        renderEditor();
      });
      $("#filterInput").addEventListener("input", () => renderEditor());
      $("#toggleShowEN").addEventListener("change", () => renderEditor());

      $("#btnSave").addEventListener("click", () => {
        toast("Updated the model in memory");
      });

      $("#btnCopy").addEventListener("click", async () => {
        if (!state.translations) {
          alert("Load a file first !");
          return;
        }
        const content = buildJsFile();
        try {
          await navigator.clipboard.writeText(content);
          toast("Copied to your clipboard ! ‚úÖ");
        } catch {
          alert(
            "Unable to copy for you'll have to export as JS and copy the content of the dowloaded file."
          );
        }
      });

      $("#btnDownload").addEventListener("click", () => {
        if (!state.translations) {
          alert("Load a file first !");
          return;
        }
        download("translations.js", buildJsFile());
      });
      $("#btnDownloadJSON").addEventListener("click", () => {
        if (!state.translations) {
          alert("Load a file first !");
          return;
        }
        download(
          "translations.json",
          JSON.stringify(state.translations, null, 2)
        );
      });

      $("#btnSaveMem").addEventListener("click", () => {
        try {
          localStorage.setItem(
            "tf2.translations",
            JSON.stringify(state.translations)
          );
          toast("Locally saved");
        } catch {
          toast("Failed to save locally");
        }
      });
      $("#btnLoadMem").addEventListener("click", () => {
        try {
          const raw = localStorage.getItem("tf2.translations");
          if (!raw) {
            toast("No local save");
            return;
          }
          state.translations = JSON.parse(raw);
          state.originalSnapshot = JSON.parse(
            JSON.stringify(state.translations)
          );
          const meta = deriveKeysAndLangs(state.translations);
          state.langs = meta.langs;
          state.keys = meta.keys;
          state.activeLang = state.langs.includes("FR") ? "FR" : state.langs[0];
          renderLangs();
          renderKeysBar();
          renderEditor();
          updateParsedStatus(true);
          toast("loaded from browser");
        } catch (e) {
          toast("Error in local loading");
        }
      });

      $("#btnShowDiffFile").addEventListener("click", () => {
        if (!state.originalSnapshot || !state.translations) {
          alert("Slow down lad ! Load up a file and analyse it first !");
          return;
        }
        const left = JSON.stringify(state.originalSnapshot, null, 2);
        const right = JSON.stringify(state.translations, null, 2);
        const diff = Diff.diffWords(left, right);
        const html = diff
          .map((part) =>
            part.added
              ? `<ins>${escapeHtml(part.value)}</ins>`
              : part.removed
              ? `<del>${escapeHtml(part.value)}</del>`
              : escapeHtml(part.value)
          )
          .join("");
        const box = $("#fileDiff");
        box.innerHTML = html;
        box.style.display = "block";
        box.scrollIntoView({ behavior: "smooth" });
      });

      // ---------- Utilities ------------------------------------------------
      function buildJsFile() {
        return (
          "const translations = " + JSON.stringify(state.translations, null, 2)
        );
      }
      function download(filename, content) {
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // ---------- Init: try load from local -------------------------------
      window.addEventListener("DOMContentLoaded", () => {
        try {
          const raw = localStorage.getItem("tf2.translations");
          if (raw) {
            state.translations = JSON.parse(raw);
            state.originalSnapshot = JSON.parse(
              JSON.stringify(state.translations)
            );
            const meta = deriveKeysAndLangs(state.translations);
            state.langs = meta.langs;
            state.keys = meta.keys;
            state.activeLang = state.langs[0];
            renderLangs();
            renderKeysBar();
            renderEditor();
            updateParsedStatus(true);
          }
        } catch (e) {}
      });

      // --- Bouton par d√©faut ---
      $("#btnOpenPRDefault").addEventListener("click", async () => {
        if (!state.translations) {
          alert("Slow down lad ! Load up a file and analyse it first !");
          return;
        }
        const content = buildJsFile();
        try {
          await navigator.clipboard.writeText(content);
          toast("Fichier copi√© ‚Äì ouverture de GitHub‚Ä¶");
        } catch {}
        const url =
          "https://github.com/DRUN-s/DRUN-s.github.io/edit/main/scripts/translations.js";
        window.open(url, "_blank");
      });

      // --- Bouton custom ---
      $("#btnOpenPRCustom").addEventListener("click", async () => {
        if (!state.translations) {
          alert("Slow down lad ! Load up a file and analyse it first !");
          return;
        }
        const owner = $("#ghOwner").value.trim();
        const repo = $("#ghRepo").value.trim();
        const branch = $("#ghBranch").value.trim() || "main";
        const path = $("#ghPath").value.trim();
        if (!owner || !repo || !path) {
          alert("Fill in the owner, repo et file path.");
          return;
        }
        const content = buildJsFile();
        try {
          await navigator.clipboard.writeText(content);
          toast("File has been copied ‚Äì opening GitHub‚Ä¶");
        } catch {}
        const url = `https://github.com/${encodeURIComponent(
          owner
        )}/${encodeURIComponent(repo)}/edit/${encodeURIComponent(
          branch
        )}/${encodeURIComponent(path)}`;
        window.open(url, "_blank");
      });

      // --- Toggle avanc√© ---
      $("#toggleAdvanced").addEventListener("click", () => {
        const adv = $("#advancedGhSection");
        adv.style.display = adv.style.display === "none" ? "block" : "none";
      });
    </script>
  </body>
</html>
